<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Bodas Premium</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-purple: #8B5FBF;
            --light-purple: #B39BC8;
            --dark-purple: #6A4C93;
            --accent-pink: #F3A3C4;
            --soft-pink: #F8E1E8;
            --cream: #FAF7F2;
            --charcoal: #2D3436;
            --warm-gray: #636E72;
            --light-gray: #DDD6D6;
            --white: #FFFFFF;
            --success-green: #00B894;
            --error-red: #E17055;
            --warning-orange: #FDCB6E;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--soft-pink) 50%, var(--light-purple) 100%);
            min-height: 100vh;
            display: flex;
            gap: 20px;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* Fondo animado con part√≠culas sutiles */
        .ambient-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }

        .ambient-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent-pink);
            border-radius: 50%;
            opacity: 0.4;
            animation: ambientFloat 20s infinite linear;
        }

        .ambient-particle:nth-child(odd) {
            background: var(--light-purple);
            animation-delay: -7s;
            width: 3px;
            height: 3px;
        }

        .ambient-particle:nth-child(3n) {
            background: var(--primary-purple);
            animation-delay: -14s;
            width: 5px;
            height: 5px;
        }

        @keyframes ambientFloat {
            0% { 
                transform: translateY(100vh) translateX(0) rotate(0deg); 
                opacity: 0; 
            }
            10% { opacity: 0.4; }
            90% { opacity: 0.4; }
            100% { 
                transform: translateY(-10vh) translateX(100px) rotate(360deg); 
                opacity: 0; 
            }
        }

        /* Panel del asistente - Lado izquierdo */
        .assistant-panel {
            position: fixed;
            left: 20px;
            top: 20px;
            bottom: 20px;
            width: 420px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 225, 232, 0.9));
            border-radius: 30px;
            padding: 40px;
            box-shadow: 
                0 25px 60px rgba(139, 95, 191, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(139, 95, 191, 0.2);
            z-index: 10;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* T√≠tulo del asistente */
        .assistant-title {
            font-family: 'Playfair Display', serif;
            color: var(--primary-purple);
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(45deg, var(--primary-purple), var(--dark-purple));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleShimmer 4s ease-in-out infinite;
        }

        @keyframes titleShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .assistant-subtitle {
            color: var(--warm-gray);
            font-size: 1.1em;
            font-weight: 400;
            margin-bottom: 30px;
            text-align: center;
            font-style: italic;
        }

        /* Pareja 3D mejorada */
        .couple-display {
            width: 100%;
            height: 250px;
            margin: 20px 0;
            position: relative;
            perspective: 1000px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .couple-3d {
            position: relative;
            display: flex;
            align-items: flex-end;
            gap: 20px;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            animation: coupleIdle 8s ease-in-out infinite;
        }

        .couple-3d:hover {
            transform: scale(1.1) rotateY(8deg);
            filter: drop-shadow(0 20px 40px rgba(139, 95, 191, 0.3));
        }

        @keyframes coupleIdle {
            0%, 100% { transform: rotateY(0deg) rotateX(0deg); }
            25% { transform: rotateY(3deg) rotateX(1deg); }
            50% { transform: rotateY(0deg) rotateX(-1deg); }
            75% { transform: rotateY(-3deg) rotateX(1deg); }
        }

        /* Novia 3D con nuevos colores */
        .bride-3d {
            position: relative;
            transform-style: preserve-3d;
            animation: brideFloat3D 6s ease-in-out infinite;
        }

        @keyframes brideFloat3D {
            0%, 100% { 
                transform: translateY(0px) rotateZ(0deg) translateZ(0px); 
            }
            33% { 
                transform: translateY(-8px) rotateZ(1deg) translateZ(10px); 
            }
            66% { 
                transform: translateY(-4px) rotateZ(-0.5deg) translateZ(5px); 
            }
        }

        .bride-body-3d {
            width: 50px;
            height: 80px;
            background: linear-gradient(145deg, var(--white), var(--soft-pink), var(--white));
            border-radius: 25px 25px 40px 40px;
            position: relative;
            box-shadow: 
                0 10px 30px rgba(139, 95, 191, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.9);
            transform: translateZ(20px);
            overflow: hidden;
        }

        .bride-body-3d::before {
            content: '';
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translateX(-50%);
            width: 35px;
            height: 20px;
            background: linear-gradient(45deg, var(--accent-pink), var(--primary-purple));
            border-radius: 50%;
            opacity: 0.3;
        }

        .bride-head-3d {
            width: 38px;
            height: 38px;
            background: radial-gradient(circle at 30% 30%, #f4c2a1, #e6a373);
            border-radius: 50%;
            position: absolute;
            top: -30px;
            left: 6px;
            box-shadow: 
                0 8px 20px rgba(139, 95, 191, 0.2),
                inset 2px 2px 4px rgba(255, 255, 255, 0.3);
            transform: translateZ(25px);
        }

        .bride-veil-3d {
            width: 70px;
            height: 60px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 225, 232, 0.7));
            border-radius: 50%;
            position: absolute;
            top: -45px;
            left: -10px;
            z-index: -1;
            transform: translateZ(-10px);
            animation: veilFlow3D 4s ease-in-out infinite;
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.5);
        }

        @keyframes veilFlow3D {
            0%, 100% { 
                transform: translateZ(-10px) scale(1) rotateZ(0deg); 
                opacity: 0.9; 
            }
            50% { 
                transform: translateZ(-5px) scale(1.1) rotateZ(2deg); 
                opacity: 0.7; 
            }
        }

        /* Novio 3D con nuevos colores */
        .groom-3d {
            position: relative;
            transform-style: preserve-3d;
            animation: groomFloat3D 6s ease-in-out infinite 1s;
        }

        @keyframes groomFloat3D {
            0%, 100% { 
                transform: translateY(0px) rotateZ(0deg) translateZ(0px); 
            }
            33% { 
                transform: translateY(-10px) rotateZ(-1deg) translateZ(8px); 
            }
            66% { 
                transform: translateY(-6px) rotateZ(0.5deg) translateZ(4px); 
            }
        }

        .groom-body-3d {
            width: 45px;
            height: 85px;
            background: linear-gradient(145deg, var(--charcoal), #1a1a1a, var(--charcoal));
            border-radius: 20px 20px 30px 30px;
            position: relative;
            box-shadow: 
                0 10px 30px rgba(45, 52, 54, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.1);
            transform: translateZ(20px);
        }

        .groom-head-3d {
            width: 35px;
            height: 35px;
            background: radial-gradient(circle at 30% 30%, #f4c2a1, #e6a373);
            border-radius: 50%;
            position: absolute;
            top: -28px;
            left: 5px;
            box-shadow: 
                0 8px 20px rgba(139, 95, 191, 0.2),
                inset 2px 2px 4px rgba(255, 255, 255, 0.3);
            transform: translateZ(25px);
        }

        .groom-tie-3d {
            width: 12px;
            height: 35px;
            background: linear-gradient(145deg, var(--primary-purple), var(--dark-purple));
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%) translateZ(22px);
            border-radius: 0 0 6px 6px;
            box-shadow: 
                0 5px 15px rgba(139, 95, 191, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Estados de animaci√≥n */
        .couple-3d.listening {
            animation: coupleListening3D 2s ease-in-out infinite;
        }

        .couple-3d.processing {
            animation: coupleProcessing3D 3s linear infinite;
        }

        @keyframes coupleListening3D {
            0% { 
                transform: scale(1) rotateY(0deg); 
                filter: brightness(1) drop-shadow(0 10px 20px rgba(139, 95, 191, 0.2)); 
            }
            50% { 
                transform: scale(1.1) rotateY(5deg); 
                filter: brightness(1.3) drop-shadow(0 20px 40px var(--primary-purple)); 
            }
            100% { 
                transform: scale(1) rotateY(0deg); 
                filter: brightness(1) drop-shadow(0 10px 20px rgba(139, 95, 191, 0.2)); 
            }
        }

        @keyframes coupleProcessing3D {
            0% { 
                transform: rotateY(0deg) rotateX(0deg); 
                filter: hue-rotate(0deg); 
            }
            33% { 
                transform: rotateY(120deg) rotateX(5deg); 
                filter: hue-rotate(120deg); 
            }
            66% { 
                transform: rotateY(240deg) rotateX(-5deg); 
                filter: hue-rotate(240deg); 
            }
            100% { 
                transform: rotateY(360deg) rotateX(0deg); 
                filter: hue-rotate(360deg); 
            }
        }

        /* Controles del asistente */
        .control-section {
            margin-top: auto;
            padding-top: 30px;
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .control-btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
            color: white;
            box-shadow: 0 8px 25px rgba(139, 95, 191, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(139, 95, 191, 0.4);
            background: linear-gradient(135deg, var(--dark-purple), var(--primary-purple));
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary-purple);
            border: 2px solid var(--primary-purple);
        }

        .btn-secondary:hover {
            background: var(--primary-purple);
            color: white;
            transform: translateY(-3px);
        }

        /* Estado del asistente */
        .status-display {
            font-size: 0.9em;
            color: var(--warm-gray);
            font-weight: 500;
            padding: 15px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 95, 191, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-display.listening {
            color: var(--success-green);
            background: rgba(0, 184, 148, 0.1);
            border-color: var(--success-green);
            animation: statusPulse 2s ease-in-out infinite;
        }

        .status-display.processing {
            color: var(--primary-purple);
            background: rgba(139, 95, 191, 0.1);
            border-color: var(--primary-purple);
        }

        .status-display.error {
            color: var(--error-red);
            background: rgba(225, 112, 85, 0.1);
            border-color: var(--error-red);
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        /* Panel del chat - Lado derecho */
        .chat-panel {
            margin-left: 460px;
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 15px 40px rgba(139, 95, 191, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 95, 191, 0.15);
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 40px);
        }

        .chat-header {
            padding: 25px 30px;
            border-bottom: 1px solid rgba(139, 95, 191, 0.15);
            background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
            border-radius: 20px 20px 0 0;
            color: white;
        }

        .chat-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .chat-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chat-welcome {
            text-align: center;
            color: var(--warm-gray);
            font-style: italic;
            padding: 40px 20px;
        }

        /* Mensajes del chat */
        .message {
            max-width: 85%;
            padding: 20px 25px;
            border-radius: 20px;
            margin-bottom: 15px;
            animation: messageSlide 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant {
            align-self: flex-start;
            background: linear-gradient(135deg, var(--soft-pink), rgba(255, 255, 255, 0.9));
            color: var(--charcoal);
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(139, 95, 191, 0.1);
        }

        @keyframes messageSlide {
            0% { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .message-content {
            line-height: 1.6;
        }

        .message-time {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 8px;
        }

        /* Indicador de escritura */
        .typing-indicator {
            align-self: flex-start;
            padding: 20px 25px;
            background: rgba(139, 95, 191, 0.1);
            border-radius: 20px 20px 20px 5px;
            display: none;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary-purple);
            border-radius: 50%;
            animation: typingDot 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Elementos flotantes rom√°nticos */
        .floating-elements {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .floating-heart {
            position: absolute;
            font-size: 20px;
            color: var(--accent-pink);
            animation: heartFloat 6s infinite ease-in-out;
            pointer-events: none;
            opacity: 0.7;
        }

        @keyframes heartFloat {
            0% { 
                transform: translateY(100vh) scale(0) rotate(0deg); 
                opacity: 0; 
            }
            15% { 
                opacity: 0.7; 
                transform: translateY(85vh) scale(1) rotate(90deg); 
            }
            85% { 
                opacity: 0.7; 
                transform: translateY(15vh) scale(1.1) rotate(270deg); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-10vh) scale(0) rotate(360deg); 
            }
        }

        /* PROMPTS SUGERIDOS (nuevo) */
        .prompt-shelf {
            position: sticky;
            top: 0;
            z-index: 2;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 95, 191, 0.15);
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .prompt-shelf-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--warm-gray);
            font-size: 0.95em;
            font-weight: 600;
        }

        .prompt-chip-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .prompt-chip {
            user-select: none;
            padding: 10px 14px;
            border-radius: 9999px;
            border: 1px solid rgba(139,95,191,0.25);
            background: linear-gradient(135deg, #ffffff, #f9f2fb);
            box-shadow: 0 4px 14px rgba(139,95,191,0.08);
            color: var(--charcoal);
            font-size: 0.92em;
            font-weight: 600;
            cursor: pointer;
            transition: transform .15s ease, box-shadow .2s ease, background .2s ease;
            white-space: nowrap;
        }

        .prompt-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139,95,191,0.18);
            background: linear-gradient(135deg, #fff, #f4e7fb);
        }

        .prompt-chip.primary {
            background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
            color: #fff;
            border-color: transparent;
        }

        .prompt-chip.ghost {
            background: rgba(139,95,191,0.08);
        }

        .prompt-category {
            margin-left: auto;
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid rgba(139,95,191,0.25);
            background: rgba(255,255,255,0.8);
            color: var(--primary-purple);
            font-weight: 600;
            cursor: pointer;
        }

        /* Voice panel (mejorado para web y cel) */
        .voice-panel{
          position:fixed; inset:0; background:rgba(0,0,0,.25);
          backdrop-filter: blur(2px);
          display:none; align-items:center; justify-content:center;
          z-index:1000; padding:12px;
        }
        .voice-panel-card{
          width:min(720px,96vw);
          max-height:92vh; overflow:auto; -webkit-overflow-scrolling:touch;
          background:#fff; border-radius:18px; padding:24px;
          box-shadow:0 20px 60px rgba(139,95,191,.25);
          border:1px solid rgba(139,95,191,.2);
        }
        .voice-panel-card h3{ margin:0 0 14px; color:var(--primary-purple)}
        .voice-panel-card label{ display:block; margin:12px 0 6px; color:var(--warm-gray); font-weight:600}
        .voice-panel-card select{
          width:100%; padding:12px; border-radius:12px;
          border:1px solid rgba(139,95,191,.25); background:#fff;
        }
        .voice-actions{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:16px; }
        @media (max-width:480px){ .voice-actions{ grid-template-columns:1fr; } }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .assistant-panel {
                width: 350px;
            }
            
            .chat-panel {
                margin-left: 390px;
            }
        }

        @media (max-width: 950px) {
            body {
                flex-direction: column;
                padding: 15px;
            }
            
            .assistant-panel {
                position: relative;
                left: auto;
                top: auto;
                bottom: auto;
                width: 100%;
                height: auto;
                margin-bottom: 20px;
            }
            
            .chat-panel {
                margin-left: 0;
                min-height: 60vh;
            }
            
            .couple-display {
                height: 200px;
            }
            
            .control-buttons {
                flex-direction: row;
                gap: 10px;
            }
        }

        @media (max-width: 600px) {
            .assistant-panel {
                padding: 25px;
                border-radius: 20px;
            }
            
            .assistant-title {
                font-size: 2.2em;
            }
            
            .couple-display {
                height: 150px;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .control-btn {
                padding: 14px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Part√≠culas ambientales -->
    <div class="ambient-particles"></div>
    
    <!-- Elementos flotantes rom√°nticos -->
    <div class="floating-elements"></div>

    <!-- Panel del Asistente - Izquierda -->
    <div class="assistant-panel">
        <h1 class="assistant-title">üíç BodaBot</h1>
        <p class="assistant-subtitle">Tu asistente inteligente para bodas perfectas</p>

        <!-- Pareja 3D -->
        <div class="couple-display">
            <div class="couple-3d" id="couple3D">
                <!-- Novia 3D -->
                <div class="bride-3d">
                    <div class="bride-veil-3d"></div>
                    <div class="bride-head-3d"></div>
                    <div class="bride-body-3d"></div>
                </div>
                
                <!-- Novio 3D -->
                <div class="groom-3d">
                    <div class="groom-head-3d"></div>
                    <div class="groom-body-3d">
                        <div class="groom-tie-3d"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controles -->
        <div class="control-section">
            <div class="control-buttons">
                <button class="control-btn btn-primary" id="voiceBtn">
                    üé§ Hacer Consulta
                </button>
                <button class="control-btn btn-secondary" id="settingsBtn">
                    ‚öôÔ∏è Configuraci√≥n
                </button>
                <button class="control-btn btn-secondary" id="changeVoiceBtn">
                    üéôÔ∏è Voz
                </button>
                <!-- üëá NUEVOS BOTONES -->
                <button class="control-btn btn-secondary" id="muteBtn">
                    üîá Silencio
                </button>
                <button class="control-btn btn-secondary" id="cancelSpeechBtn">
                    ‚èπÔ∏è Cancelar Voz
                </button>
                <!-- ‚òùÔ∏è FIN NUEVOS BOTONES -->
            </div>

            <!-- Estado -->
            <div class="status-display" id="statusDisplay">
                ‚ú® Listo para ayudarte con tu boda so√±ada
            </div>
        </div>
    </div>

    <!-- Panel del Chat - Derecha -->
    <div class="chat-panel">
        <div class="chat-header">
            <div class="chat-title">üí¨ Conversaci√≥n</div>
            <div class="chat-subtitle">Todas tus consultas y respuestas aparecer√°n aqu√≠</div>
        </div>
        
        <div class="chat-content" id="chatContent">
            <!-- PROMPTS SUGERIDOS (nuevo) -->
            <div class="prompt-shelf" id="promptShelf" aria-label="Sugerencias de prompts">
                <div class="prompt-shelf-header">
                    <span>‚ú® Sugerencias r√°pidas</span>
                    <select id="promptCategory" class="prompt-category" title="Filtrar sugerencias">
                        <option value="Todos">Todos</option>
                        <option value="B√°sicos">B√°sicos</option>
                        <option value="Confirmaciones">Confirmaciones</option>
                        <option value="Mesas">Mesas</option>
                        <option value="QR y Boletos">QR y Boletos</option>
                        <option value="Contacto">Contacto</option>
                        <option value="Fichas">Fichas</option>
                        <option value="Combinados">Combinados</option>
                    </select>
                </div>
                <div class="prompt-chip-wrap" id="promptChips"></div>
            </div>

            <div class="chat-welcome">
                <p>¬°Bienvenido! üëã</p>
                <p>Presiona "Hacer Consulta", toca la pareja o elige una sugerencia para empezar.</p>
            </div>
            
            <!-- Indicador de escritura -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de selecci√≥n de voz -->
    <div id="voicePanel" class="voice-panel">
      <div class="voice-panel-card">
        <h3>Selecciona la voz</h3>

        <label>Voz del servidor (Google TTS)</label>
        <select id="serverVoiceSelect">
          <option value="">(usar predeterminada del backend)</option>
          <option value="es-ES-Neural2-H">es-ES-Neural2-H</option>
          <option value="es-ES-Neural2-F">es-ES-Neural2-F</option>
          <option value="es-ES-Neural2-C">es-ES-Neural2-C</option>
          <option value="es-MX-Neural2-F">es-MX-Neural2-F</option>
          <option value="es-MX-Neural2-B">es-MX-Neural2-B</option>
        </select>

        <label>Voz del navegador (fallback)</label>
        <select id="browserVoiceSelect"></select>

        <div class="voice-actions">
          <button id="voiceSaveBtn" class="control-btn btn-primary">Guardar</button>
          <button id="voiceTestBtn" class="control-btn btn-secondary">Probar</button>
          <button id="voiceCloseBtn" class="control-btn btn-secondary">Cerrar</button>
        </div>
      </div>
    </div>

    <script>
        class PremiumWeddingChatBot {
            constructor() {
                this.isListening = false;   // Web Speech
                this.isRecording = false;   // MediaRecorder
                this.isProcessing = false;
                this.apiUrl = window.location.origin;
                this.conversationHistory = [];
                this.media = { stream:null, recorder:null, chunks:[] };

                // Persistencia de voces seleccionadas
                this.serverVoiceName  = localStorage.getItem('bodabot_serverVoiceName')  || '';
                this.browserVoiceName = localStorage.getItem('bodabot_browserVoiceName') || '';
                
                // Detecci√≥n de dispositivo/soporte
                this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                this.supportsWebSpeech = 'webkitSpeechRecognition' in window && !this.isIOS; // iOS no soporta
                this.supportsMediaRecorder = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia && window.MediaRecorder);
                this.voiceMode = this.supportsWebSpeech ? 'webspeech' : (this.supportsMediaRecorder ? 'record' : 'none');

                // Para desbloquear audio en iOS
                this.didUserInteract = false;
                const unlock = () => { this.didUserInteract = true; document.removeEventListener('touchstart', unlock, {passive:true}); document.removeEventListener('click', unlock); };
                document.addEventListener('touchstart', unlock, { passive:true });
                document.addEventListener('click', unlock);

                // Prompts sugeridos por categor√≠a (nuevo)
                this.PROMPTS = {
                    "B√°sicos": [
                        "lista de invitados",
                        "¬øcu√°ntos confirmados?",
                        "sin mesa",
                        "mesas (por mesa)",
                        "boletos"
                    ],
                    "Confirmaciones": [
                        "confirmados",
                        "qui√©nes asistir√°n",
                        "confirmados de la mesa 12",
                        "solo misa"
                    ],
                    "Mesas": [
                        "invitados de la mesa 12",
                        "invitados de la mesa 7",
                        "sin mesa",
                        "confirmados de la mesa 5"
                    ],
                    "QR y Boletos": [
                        "QR enviados",
                        "QR confirmados",
                        "boletos confirmados",
                        "¬øcu√°ntos boletos faltan?"
                    ],
                    "Contacto": [
                        "tel√©fono de Carmen Ch√°vez",
                        "correo de Farah",
                        "gmail.com",
                        "tel 33"
                    ],
                    "Fichas": [
                        "ficha de Araceli Figueroa",
                        "ficha de Enrique Ch√°vez",
                        "ficha de Karla Calleros"
                    ],
                    "Combinados": [
                        "confirmados con QR enviado",
                        "sin mesa y correo gmail",
                        "confirmados de mesa 12 con QR confirmado"
                    ],
                    "Todos": [] // se rellena din√°micamente
                };

                this.initializeElements();
                this.setupEventListeners();
                this.initializeAnimations();
                this.setupSpeechRecognition();
                this.startAmbientEffects();
                this.prepareAllPrompts(); // nuevo
                this.renderPromptChips(); // nuevo

                // Ajustar bot√≥n de voz seg√∫n soporte
                this.refreshVoiceButtonLabel();

                // Estado de voces
                this.voicesReady = false;
            }

            initializeElements() {
                this.couple3D = document.getElementById('couple3D');
                this.voiceBtn = document.getElementById('voiceBtn');
                this.settingsBtn = document.getElementById('settingsBtn');
                this.statusDisplay = document.getElementById('statusDisplay');
                this.chatContent = document.getElementById('chatContent');
                this.typingIndicator = document.getElementById('typingIndicator');

                // elementos de prompts (nuevo)
                this.promptShelf = document.getElementById('promptShelf');
                this.promptChips = document.getElementById('promptChips');
                this.promptCategory = document.getElementById('promptCategory');

                // elementos de voz (nuevo)
                this.changeVoiceBtn     = document.getElementById('changeVoiceBtn');
                this.voicePanel         = document.getElementById('voicePanel');
                this.serverVoiceSelect  = document.getElementById('serverVoiceSelect');
                this.browserVoiceSelect = document.getElementById('browserVoiceSelect');
                this.voiceSaveBtn       = document.getElementById('voiceSaveBtn');
                this.voiceCloseBtn      = document.getElementById('voiceCloseBtn');
                this.voiceTestBtn       = document.getElementById('voiceTestBtn');
            }

            refreshVoiceButtonLabel() {
                if (!this.voiceBtn) return;
                if (this.voiceMode === 'webspeech') {
                    this.voiceBtn.textContent = this.isListening ? 'üõë Detener' : 'üé§ Hacer Consulta';
                } else if (this.voiceMode === 'record') {
                    this.voiceBtn.textContent = this.isRecording ? '‚èπÔ∏è Detener grabaci√≥n' : 'üéôÔ∏è Grabar consulta';
                } else {
                    this.voiceBtn.textContent = '‚å®Ô∏è Escribir consulta';
                }
            }

            async playServerTTS(text) {
              try {
                if (this.voiceMuted) return;

                // Si el usuario eligi√≥ una voz es-MX, ajusta el language autom√°ticamente
                const lang = (this.serverVoiceName && this.serverVoiceName.startsWith('es-MX')) ? 'es-MX' : 'es-ES';

                const resp = await fetch(`${this.apiUrl}/tts`, {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({
                    text,
                    language: lang,
                    voice_name: this.serverVoiceName || null, // <--- usa la voz elegida
                    format: 'mp3'
                  })
                });
                if (!resp.ok) throw new Error('TTS server error');
                const data = await resp.json();
                if (data.audio_base64 && data.mime) {
                  const audio = new Audio(`data:${data.mime};base64,${data.audio_base64}`);
                  if (this.didUserInteract) {
                    await audio.play().catch(()=>{});
                  }
                }
              } catch (e) {
                // Fallback: si el servidor TTS falla, usa la voz del navegador
                if ('speechSynthesis' in window) {
                  this.speakResponse(text);
                }
              }
            }

            setupEventListeners() {
                // Bot√≥n principal de voz: maneja ambos modos (webspeech o grabaci√≥n)
                const onVoiceButton = () => {
                    if (this.voiceMode === 'webspeech') {
                        this.toggleVoiceInteraction();
                    } else if (this.voiceMode === 'record') {
                        this.toggleRecording();
                    } else {
                        this.addSystemMessage('Tu navegador no soporta reconocimiento de voz. Usa el teclado o agrega un endpoint /stt en tu backend.');
                    }
                };

                this.voiceBtn.addEventListener('click', onVoiceButton);
                this.couple3D.addEventListener('click', onVoiceButton);
                this.settingsBtn.addEventListener('click', () => this.showConfiguration());
                
                // Abrir panel de voz
                if (this.changeVoiceBtn) this.changeVoiceBtn.addEventListener('click', () => this.openVoicePanel());

                // Guardar voz
                if (this.voiceSaveBtn) this.voiceSaveBtn.addEventListener('click', () => {
                  this.serverVoiceName  = this.serverVoiceSelect.value || '';
                  this.browserVoiceName = this.browserVoiceSelect.value || '';
                  localStorage.setItem('bodabot_serverVoiceName',  this.serverVoiceName);
                  localStorage.setItem('bodabot_browserVoiceName', this.browserVoiceName);
                  this.addSystemMessage(`Voz guardada. Servidor: ${this.serverVoiceName || '(predeterminada)'} ¬∑ Navegador: ${this.browserVoiceName || '(autom√°tica)'}`);
                  this.voicePanel.style.display = 'none';
                });

                // Cerrar panel
                if (this.voiceCloseBtn) this.voiceCloseBtn.addEventListener('click', () => {
                  this.voicePanel.style.display = 'none';
                });

                // Probar voz del navegador (usa la voz seleccionada en el combo SIN necesidad de guardar)
                if (this.voiceTestBtn) this.voiceTestBtn.addEventListener('click', () => {
                  const tempName = (this.browserVoiceSelect && this.browserVoiceSelect.value) ? this.browserVoiceSelect.value : (this.browserVoiceName || '');
                  this.speakResponse('Esta es la voz seleccionada para el navegador.', { voiceName: tempName });
                });

                // Efectos visuales
                this.couple3D.addEventListener('mouseenter', () => {
                    if (!this.isListening && !this.isProcessing) {
                        this.couple3D.style.filter = 'drop-shadow(0 25px 50px rgba(139, 95, 191, 0.4))';
                    }
                });
                
                this.couple3D.addEventListener('mouseleave', () => {
                    if (!this.isListening && !this.isProcessing) {
                        this.couple3D.style.filter = '';
                    }
                });

                // Click en chips de prompts (nuevo)
                this.promptChips.addEventListener('click', (e) => {
                    const chip = e.target.closest('.prompt-chip');
                    if (!chip) return;
                    const text = chip.getAttribute('data-prompt');
                    if (text) {
                        this.removeWelcomeMessage();
                        this.addUserMessage(text);
                        this.processUserQuery(text);
                    }
                });

                // Cambio de categor√≠a (nuevo)
                this.promptCategory.addEventListener('change', () => {
                    this.renderPromptChips(this.promptCategory.value);
                });
            }

            // Panel de voz
            openVoicePanel(){
              if (this.serverVoiceSelect)  this.serverVoiceSelect.value  = this.serverVoiceName || '';
              // Asegurar que las voces del navegador est√©n listas y poblar
              this.ensureVoicesReady();
              if (this.browserVoiceSelect) this.populateBrowserVoices();
              this.voicePanel.style.display = 'flex';
            }

            // Garantiza que speechSynthesis tenga voces (desktop/web y m√≥viles)
            ensureVoicesReady(){
              if (!('speechSynthesis' in window)) return;
              const tryLoad = (attempt = 0) => {
                const list = speechSynthesis.getVoices();
                if (list && list.length) {
                  this.voicesReady = true;
                  this.populateBrowserVoices();
                  return;
                }
                // "Calentamiento" (necesario en iOS/ciertos navegadores)
                if (attempt === 0) {
                  try {
                    const u = new SpeechSynthesisUtterance(' ');
                    u.volume = 0; u.rate = 1; u.pitch = 1;
                    speechSynthesis.speak(u);
                    setTimeout(() => { try { speechSynthesis.cancel(); } catch(e){} }, 60);
                  } catch(e){}
                }
                if (attempt < 20) {
                  setTimeout(() => tryLoad(attempt + 1), 200);
                }
              };
              tryLoad();
            }

            populateBrowserVoices(){
              if (!('speechSynthesis' in window) || !this.browserVoiceSelect) return;

              const all = speechSynthesis.getVoices();

              // Si a√∫n no est√°n listas, mostrar estado y reintentar
              if (!all || all.length === 0) {
                this.browserVoiceSelect.innerHTML = '';
                const loading = document.createElement('option');
                loading.value = '';
                loading.textContent = '(cargando voces...)';
                this.browserVoiceSelect.appendChild(loading);
                setTimeout(() => this.populateBrowserVoices(), 300);
                return;
              }

              // Orden: espa√±ol primero, luego el resto (para que aparezcan "todas" en web y cel)
              const es = all.filter(v => (v.lang || '').toLowerCase().startsWith('es'));
              const rest = all.filter(v => !(v.lang || '').toLowerCase().startsWith('es'));
              const ordered = es.concat(rest);

              this.browserVoiceSelect.innerHTML = '';
              const auto = document.createElement('option');
              auto.value = '';
              auto.textContent = '(autom√°tica en espa√±ol)';
              this.browserVoiceSelect.appendChild(auto);

              ordered.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.textContent = `${v.name} (${v.lang || 'sin-lang'})`;
                this.browserVoiceSelect.appendChild(opt);
              });

              // Intentar seleccionar la guardada o dejar autom√°tica
              if (this.browserVoiceName) {
                this.browserVoiceSelect.value = this.browserVoiceName;
              } else {
                this.browserVoiceSelect.value = '';
              }
            }

            // Rellena "Todos" con la uni√≥n de categor√≠as (nuevo)
            prepareAllPrompts() {
                const all = new Set();
                Object.keys(this.PROMPTS).forEach(cat => {
                    if (cat !== "Todos") {
                        this.PROMPTS[cat].forEach(p => all.add(p));
                    }
                });
                this.PROMPTS["Todos"] = Array.from(all);
            }

            // Pintar chips seg√∫n categor√≠a (nuevo)
            renderPromptChips(category = "Todos") {
                const items = (this.PROMPTS[category] || []).slice(0, 24);
                this.promptChips.innerHTML = "";

                const primarySet = new Set([
                    "lista de invitados", "¬øcu√°ntos confirmados?",
                    "invitados de la mesa 12", "confirmados", "QR confirmados", "boletos"
                ]);

                items.forEach(text => {
                    const chip = document.createElement('button');
                    chip.className = 'prompt-chip' + (primarySet.has(text) ? ' primary' : '');
                    chip.textContent = this.decoratePrompt(text);
                    chip.setAttribute('data-prompt', text);
                    chip.title = text;
                    this.promptChips.appendChild(chip);
                });
            }

            // Le meto algunos emojis sutiles a los chips (nuevo)
            decoratePrompt(text) {
                const t = text.toLowerCase();
                if (t.includes('mesa')) return `üçΩÔ∏è ${text}`;
                if (t.includes('confirm')) return `‚úÖ ${text}`;
                if (t.includes('qr')) return `üî≥ ${text}`;
                if (t.includes('bolet')) return `üéüÔ∏è ${text}`;
                if (t.includes('tel')) return `üìû ${text}`;
                if (t.includes('correo') || t.includes('gmail')) return `üìß ${text}`;
                if (t.includes('ficha')) return `ü™™ ${text}`;
                if (t.includes('lista')) return `üìù ${text}`;
                return `‚ú® ${text}`;
            }

            /* ===============================
               RECONOCIMIENTO DE VOZ / GRABACI√ìN
               =============================== */
            setupSpeechRecognition() {
                if (this.supportsWebSpeech) {
                    try {
                        this.recognition = new webkitSpeechRecognition();
                        this.recognition.lang = 'es-ES';
                        this.recognition.interimResults = false;
                        this.recognition.maxAlternatives = 1;
                        this.recognition.continuous = false;

                        this.recognition.onresult = (event) => {
                            const transcript = event.results[0][0].transcript;
                            this.addUserMessage(transcript);
                            this.processUserQuery(transcript);
                        };

                        this.recognition.onerror = (event) => {
                            this.handleError(`Error de reconocimiento: ${event.error}`);
                        };

                        this.recognition.onend = () => {
                            this.stopListening();
                        };
                    } catch (e) {
                        // Si falla, cae a grabaci√≥n
                        this.supportsWebSpeech = false;
                        if (this.supportsMediaRecorder) this.voiceMode = 'record';
                        this.refreshVoiceButtonLabel();
                    }
                } else {
                    // No mostrar error aqu√≠: usamos fallback a grabaci√≥n si existe
                    if (this.supportsMediaRecorder) {
                        this.voiceMode = 'record';
                    } else {
                        this.voiceMode = 'none';
                    }
                    this.refreshVoiceButtonLabel();
                }
            }

            toggleVoiceInteraction() {
                if (!this.recognition) {
                    this.handleError('Reconocimiento de voz no disponible');
                    return;
                }
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            }

            startListening() {
                if (!this.recognition) {
                    this.handleError('Reconocimiento de voz no disponible');
                    return;
                }

                this.isListening = true;
                this.couple3D.classList.add('listening');
                this.voiceBtn.textContent = 'üõë Detener';
                this.voiceBtn.style.background = 'linear-gradient(135deg, #E17055, #c0392b)';
                this.updateStatus('üéß Escuchando tu consulta...', 'listening');
                
                try {
                    this.recognition.start();
                } catch (error) {
                    this.handleError('No se pudo iniciar el reconocimiento de voz');
                }
            }

            stopListening() {
                this.isListening = false;
                this.couple3D.classList.remove('listening');
                this.voiceBtn.style.background = '';
                this.refreshVoiceButtonLabel();
                this.updateStatus('‚ú® Listo para ayudarte con tu boda so√±ada', '');

                if (this.recognition) {
                    try {
                        this.recognition.stop();
                    } catch (error) {
                        console.warn('Error al detener reconocimiento:', error);
                    }
                }
            }

            /* ======= Fallback: Grabaci√≥n a /stt (para iOS u otros) ======= */
            async toggleRecording(){
                if (!this.supportsMediaRecorder) { 
                    this.handleError('Grabaci√≥n no soportada en este navegador');
                    return;
                }
                if (this.isRecording) {
                    await this.stopRecording(true);
                } else {
                    await this.startRecording();
                }
            }

            async startRecording(){
                try{
                    this.media.stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true }});
                    let mime = '';
                    if (MediaRecorder.isTypeSupported('audio/webm')) mime = 'audio/webm';
                    else if (MediaRecorder.isTypeSupported('audio/mp4')) mime = 'audio/mp4';
                    else if (MediaRecorder.isTypeSupported('audio/ogg')) mime = 'audio/ogg';

                    this.media.recorder = new MediaRecorder(this.media.stream, mime ? { mimeType: mime } : undefined);
                    this.media.chunks = [];
                    this.media.recorder.ondataavailable = (e)=>{ if (e.data && e.data.size>0) this.media.chunks.push(e.data); };
                    this.media.recorder.onstop = async ()=>{
                        const blob = new Blob(this.media.chunks, { type: mime || 'audio/webm' });
                        await this.sendAudioToSTT(blob);
                        (this.media.stream.getTracks()||[]).forEach(t=>t.stop());
                        this.media.stream = null; this.media.recorder = null; this.media.chunks = [];
                    };

                    this.isRecording = true;
                    this.couple3D.classList.add('listening');
                    this.updateStatus('üéôÔ∏è Grabando... toca de nuevo para detener', 'listening');
                    this.refreshVoiceButtonLabel();
                    this.media.recorder.start();
                }catch(e){
                    this.handleError('No se pudo acceder al micr√≥fono. Revisa permisos.');
                }
            }

            async stopRecording(userRequested=false){
                if (!this.isRecording) return;
                this.isRecording = false;
                this.couple3D.classList.remove('listening');
                this.updateStatus('Procesando tu audio...', 'processing');
                this.refreshVoiceButtonLabel();
                try{ this.media.recorder && this.media.recorder.stop(); }catch{}
            }

            async sendAudioToSTT(blob){
                // Requiere endpoint /stt que devuelva { text } o { transcript }
                try{
                    const fd = new FormData();
                    fd.append('file', blob, `input.${(blob.type.split('/')[1]||'webm')}`);
                    fd.append('mime', blob.type || 'audio/webm');

                    const resp = await fetch(`${this.apiUrl}/stt`, { method:'POST', body: fd });
                    if (!resp.ok) throw new Error('STT server error');
                    const data = await resp.json();
                    const text = (data && (data.text || data.transcript)) || '';
                    if (!text){
                        this.addSystemMessage('No se detect√≥ voz en el audio.');
                        this.updateStatus('‚ú® Listo para ayudarte con tu boda so√±ada','');
                        return;
                    }
                    this.addUserMessage(text);
                    await this.processUserQuery(text);
                }catch(e){
                    this.handleError('No es posible convertir tu audio a texto. ¬øTienes /stt activo en el backend?');
                }
            }

            async processUserQuery(query) {
                this.setProcessingState();
                this.showTypingIndicator();
                
                try {
                    const response = await fetch(`${this.apiUrl}/ask`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            question: query,
                            max_ctx_items: 40,
                            temperature: 0.2
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    this.hideTypingIndicator();
                    this.addAssistantMessage(data.answer);
                    await this.playServerTTS(data.answer);

                    
                } catch (error) {
                    console.error('Error de API:', error);
                    let errorMessage = 'Disculpa, no pude procesar tu consulta en este momento.';
                    
                    if (error.message.includes('Failed to fetch')) {
                        errorMessage = 'No hay conexi√≥n con el sistema. Verifica que el servicio est√© disponible.';
                    }
                    
                    this.hideTypingIndicator();
                    this.addAssistantMessage(errorMessage);
                    this.speakResponse(errorMessage);
                }

                this.clearProcessingState();
            }

            setProcessingState() {
                this.isProcessing = true;
                this.couple3D.classList.add('processing');
                this.updateStatus('üí≠ Procesando tu consulta...', 'processing');
                this.couple3D.style.filter = 'drop-shadow(0 20px 40px rgba(139, 95, 191, 0.6))';
            }

            clearProcessingState() {
                this.isProcessing = false;
                this.couple3D.classList.remove('processing');
                this.couple3D.style.filter = '';
                this.updateStatus('‚ú® Listo para ayudarte con tu boda so√±ada', '');
            }

            addUserMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="message-content">${this.escapeHtml(text)}</div>
                    <div class="message-time">${this.getCurrentTime()}</div>
                `;
                
                this.chatContent.insertBefore(messageDiv, this.typingIndicator);
                this.scrollToBottom();
                
                this.conversationHistory.push({
                    type: 'user',
                    content: text,
                    timestamp: new Date()
                });
            }

            addAssistantMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                
                const formattedText = this.formatResponseText(text);
                messageDiv.innerHTML = `
                    <div class="message-content">${formattedText}</div>
                    <div class="message-time">${this.getCurrentTime()}</div>
                `;
                
                this.chatContent.insertBefore(messageDiv, this.typingIndicator);
                this.scrollToBottom();
                
                this.conversationHistory.push({
                    type: 'assistant',
                    content: text,
                    timestamp: new Date()
                });
            }

            showTypingIndicator() {
                this.typingIndicator.style.display = 'block';
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.chatContent.scrollTop = this.chatContent.scrollHeight;
                }, 100);
            }

            getCurrentTime() {
                return new Date().toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            formatResponseText(text) {
                return (text || '')
                    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--primary-purple); font-weight: 600;">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em style="color: var(--dark-purple); font-style: italic;">$1</em>')
                    .replace(/‚Ä¢/g, '<span style="color: var(--primary-purple); font-weight: bold;">‚Ä¢</span>')
                    .replace(/(\d+\.)/g, '<span style="color: var(--primary-purple); font-weight: 600;">$1</span>')
                    .replace(/(\$[\d,]+)/g, '<span style="color: var(--success-green); font-weight: 600;">$1</span>')
                    .replace(/(üìû|üìß|üí∞|üïê|üë§|üíç|üíê|üå∏|üî≥|üéüÔ∏è|üçΩÔ∏è|ü™™|üìù)/g, '<span style="font-size: 1.1em;">$1</span>')
                    .replace(/\n/g, '<br>');
            }

            // Ahora acepta un 2¬∫ par√°metro opcional para probar una voz espec√≠fica sin guardar
            speakResponse(text, opts = {}) {
                if (!('speechSynthesis' in window)) return;
                if (this.voiceMuted) return;
                try { speechSynthesis.cancel(); } catch(e) {}
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                utterance.pitch = 1.05;
                utterance.volume = 0.95;
                
                const preferredName = opts.voiceName || this.browserVoiceName || (this.browserVoiceSelect ? this.browserVoiceSelect.value : '');
                const voices = speechSynthesis.getVoices();
                let chosen = null;

                if (preferredName) {
                  chosen = voices.find(v => v.name === preferredName) || null;
                }
                // Si no hay elecci√≥n clara, toma alguna en espa√±ol y, si no, la primera disponible
                if (!chosen) {
                  chosen = voices.find(v => (v.lang || '').toLowerCase().startsWith('es')) || voices[0] || null;
                }
                if (chosen) utterance.voice = chosen;
                
                try { speechSynthesis.speak(utterance); } catch(e) {}
            }

            updateStatus(message, type) {
                this.statusDisplay.textContent = message;
                this.statusDisplay.className = `status-display ${type}`;
            }

            handleError(message) {
                this.updateStatus(`‚ùå ${message}`, 'error');
                if (this.isListening) this.stopListening();
                if (this.isRecording) this.stopRecording(false);
                this.clearProcessingState();
                this.hideTypingIndicator();
                
                setTimeout(() => {
                    if (this.statusDisplay.classList.contains('error')) {
                        this.updateStatus('‚ú® Listo para ayudarte con tu boda so√±ada', '');
                    }
                }, 5000);
            }

            showConfiguration() {
                const newUrl = prompt(
                    'üîß Configuraci√≥n de la API\n\n' +
                    'URL actual: ' + this.apiUrl + '\n\n' +
                    'Ingrese la nueva URL:', 
                    this.apiUrl
                );
                
                if (newUrl && newUrl.trim()) {
                    this.apiUrl = newUrl.trim().replace(/\/$/, '');
                    this.updateStatus('‚öôÔ∏è Configuraci√≥n actualizada', 'processing');
                    
                    this.testApiConnection();
                    
                    setTimeout(() => {
                        this.updateStatus('‚ú® Listo para ayudarte con tu boda so√±ada', '');
                    }, 4000);
                }
            }

            async testApiConnection() {
                try {
                    const response = await fetch(`${this.apiUrl}/health`, {
                        method: 'GET',
                        timeout: 5000
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.updateStatus(
                            `‚úÖ Conectado - ${data.tables_count || 0} fuentes de datos`, 
                            'processing'
                        );
                        this.addSystemMessage(`Sistema conectado correctamente. ${data.tables_count || 0} fuentes de datos disponibles.`);
                    } else {
                        this.updateStatus('‚ö†Ô∏è API responde con errores', 'error');
                    }
                } catch (error) {
                    this.updateStatus('‚ùå Sin conexi√≥n al servidor', 'error');
                }
            }

            addSystemMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                messageDiv.style.opacity = '0.8';
                messageDiv.style.fontSize = '0.9em';
                messageDiv.innerHTML = `
                    <div class="message-content">üîß <em>${this.escapeHtml(text)}</em></div>
                    <div class="message-time">${this.getCurrentTime()}</div>
                `;
                
                this.chatContent.insertBefore(messageDiv, this.typingIndicator);
                this.scrollToBottom();
            }

            initializeAnimations() {
                this.createAmbientParticles();
            }

            createAmbientParticles() {
                const particlesContainer = document.querySelector('.ambient-particles');
                const particleCount = window.innerWidth > 768 ? 20 : 10;
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'ambient-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDuration = (Math.random() * 15 + 15) + 's';
                    particle.style.animationDelay = Math.random() * 5 + 's';
                    particle.style.opacity = Math.random() * 0.3 + 0.2;
                    particlesContainer.appendChild(particle);
                }
            }

            startAmbientEffects() {
                setInterval(() => this.createFloatingHeart(), 5000);
                for (let i = 0; i < 2; i++) {
                    setTimeout(() => this.createFloatingHeart(), i * 2000);
                }
            }

            createFloatingHeart() {
                const floatingContainer = document.querySelector('.floating-elements');
                const heart = document.createElement('div');
                heart.className = 'floating-heart';
                
                const romanticSymbols = [
                    'üíï', 'üíñ', 'üíù', 'üíó', 'üíì', 'üíç', 'üíê', 
                    'üå∏', 'üå∫', 'üå∑', 'üåπ', '‚ú®', 'üí´', '‚≠ê',
                    'ü§ç', 'üíú', 'üçæ', 'ü•Ç', 'üíí', 'üë∞', 'ü§µ'
                ];
                
                heart.textContent = romanticSymbols[Math.floor(Math.random() * romanticSymbols.length)];
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDuration = (Math.random() * 2 + 5) + 's';
                heart.style.fontSize = (Math.random() * 6 + 18) + 'px';
                heart.style.color = Math.random() > 0.5 ? 'var(--accent-pink)' : 'var(--primary-purple)';
                
                floatingContainer.appendChild(heart);
                
                setTimeout(() => {
                    if (heart.parentNode) {
                        heart.parentNode.removeChild(heart);
                    }
                }, 7000);
            }

            clearChat() {
                const messages = this.chatContent.querySelectorAll('.message');
                messages.forEach(message => message.remove());
                
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'chat-welcome';
                welcomeDiv.innerHTML = `
                    <p>¬°Chat limpiado! üßπ</p>
                    <p>Listo para una nueva conversaci√≥n sobre tu boda perfecta.</p>
                `;
                this.chatContent.insertBefore(welcomeDiv, this.typingIndicator);
                
                this.conversationHistory = [];
            }

            exportChat() {
                if (this.conversationHistory.length === 0) {
                    alert('No hay conversaci√≥n para exportar.');
                    return;
                }
                
                const chatText = this.conversationHistory.map(msg => {
                    const time = msg.timestamp.toLocaleString('es-ES');
                    const sender = msg.type === 'user' ? 'Usuario' : 'BodaBot';
                    return `[${time}] ${sender}: ${msg.content}`;
                }).join('\n\n');
                
                const blob = new Blob([chatText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `conversacion-bodabot-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }

            initialize() {
                this.testApiConnection();
                setTimeout(() => {
                    if (!this.isListening && !this.isProcessing) {
                        this.updateStatus('üí¨ Haz clic en "Hacer Consulta" para comenzar', '');
                    }
                }, 3000);
                
                this.originalWelcome = this.chatContent.querySelector('.chat-welcome');
            }

            removeWelcomeMessage() {
                if (this.originalWelcome && this.originalWelcome.parentNode) {
                    this.originalWelcome.remove();
                    this.originalWelcome = null;
                }
            }

            // Utils
            escapeHtml(str) {
                return (str || '').replace(/[&<>"']/g, m => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                }[m]));
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            const chatBot = new PremiumWeddingChatBot();
            chatBot.initialize();
            
            if ('speechSynthesis' in window) {
                // Poblar voces cuando est√©n listas
                const populate = () => chatBot.populateBrowserVoices();
                speechSynthesis.addEventListener('voiceschanged', populate);
                // Asegurar carga en web/desktop y m√≥vil
                chatBot.ensureVoicesReady();
                setTimeout(populate, 300); // fallback por si no dispara el evento
            }
            
            window.addEventListener('beforeunload', () => {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
            });
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && 'speechSynthesis' in window) {
                    speechSynthesis.pause();
                } else if (!document.hidden && 'speechSynthesis' in window) {
                    speechSynthesis.resume();
                }
            });

            const originalAddUserMessage = chatBot.addUserMessage.bind(chatBot);
            chatBot.addUserMessage = function(text) {
                this.removeWelcomeMessage();
                return originalAddUserMessage(text);
            };

            /* =====================
               NUEVO: MUTE & CANCEL
               ===================== */

            // Estado persistente para el mute
            chatBot.voiceMuted = localStorage.getItem('bodabot_voiceMuted') === 'true';

            // Referencias a los botones reci√©n agregados
            const muteBtn = document.getElementById('muteBtn');
            const cancelSpeechBtn = document.getElementById('cancelSpeechBtn');

            // Wrapper para respetar el mute
            const originalSpeak = chatBot.speakResponse.bind(chatBot);
            chatBot.speakResponse = function(text, opts) {
                if (this.voiceMuted) return; // no hablar si est√° en silencio
                return originalSpeak(text, opts);
            };

            // Sincroniza texto del bot√≥n Mute
            const syncMuteUI = () => {
                if (!muteBtn) return;
                muteBtn.textContent = chatBot.voiceMuted ? 'üîä Con Voz' : 'üîá Silencio';
                muteBtn.title = chatBot.voiceMuted ? 'Desactivar silencio' : 'Activar silencio';
            };
            syncMuteUI();

            // Click en Mute
            if (muteBtn) {
                muteBtn.addEventListener('click', () => {
                    chatBot.voiceMuted = !chatBot.voiceMuted;
                    localStorage.setItem('bodabot_voiceMuted', chatBot.voiceMuted ? 'true' : 'false');
                    syncMuteUI();
                    chatBot.addSystemMessage(chatBot.voiceMuted ? 'üîá Voz silenciada. No leer√© en voz alta.' : 'üîä Voz activada.');
                });
            }

            // Click en Cancelar voz
            if (cancelSpeechBtn) {
                cancelSpeechBtn.addEventListener('click', () => {
                    try {
                        if ('speechSynthesis' in window) speechSynthesis.cancel();
                    } catch (e) {}
                    if (chatBot.isListening) chatBot.stopListening(); // por si estaba escuchando
                    if (chatBot.isRecording) chatBot.stopRecording(true); // por si estaba grabando
                    chatBot.updateStatus('üõë Reproducci√≥n/Grabaci√≥n detenida', '');
                    chatBot.addSystemMessage('‚èπÔ∏è Voz detenida.');
                });
            }
        });
    </script>
</body>
</html>
